pipeline {
  agent any
  environment {
    DOCKER_REGISTRY = "registry.example.com"
    DOCKER_USERNAME = credentials('docker-username')
    DOCKER_PASSWORD = credentials('docker-password')
    DOCKER_IMAGE_NAME = "my-app"
  }
  stages {
    stage("Build and Push Image") {
      steps {
        script {
          def branchName = env.BRANCH_NAME.toLowerCase()
          def imageNameWithTag = "${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${branchName}-${env.BUILD_NUMBER}"
          
          sh "docker build -t ${imageNameWithTag} ."
          sh "docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} ${DOCKER_REGISTRY}"
          sh "docker push ${imageNameWithTag}"
        }
      }
      post {
        success {
          echo "Image built and pushed successfully!"
        }
        failure {
          echo "Failed to build and push image."
        }
      }
    }
  }
  post {
    always {
      deleteDir()
    }
  }
}

