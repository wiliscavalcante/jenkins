pipeline {
  agent any
  environment {
    DOCKER_REGISTRY = "registry.example.com"
    DOCKER_USERNAME = credentials('docker-username')
    DOCKER_PASSWORD = credentials('docker-password')
    DOCKER_IMAGE_NAME = "my-app"
  }
  stages {
    stage("Build Image") {
      steps {
        script {
          def branchName = env.BRANCH_NAME.toLowerCase()
          def imageNameWithTag = "${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${branchName}-${env.BUILD_NUMBER}"
          
          sh "docker build -t ${imageNameWithTag} ."
          env.IMAGE_NAME_WITH_TAG = imageNameWithTag
        }
      }
      post {
        success {
          echo "Image built successfully!"
        }
        failure {
          echo "Failed to build image."
        }
      }
    }
    stage("Push Image") {
      when {
        branch 'main'
      }
      steps {
        script {
          sh "docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD} ${DOCKER_REGISTRY}"
          sh "docker push ${env.IMAGE_NAME_WITH_TAG}"
        }
      }
      post {
        success {
          echo "Image pushed successfully!"
        }
        failure {
          echo "Failed to push image."
        }
      }
    }
  }
  post {
    always {
      deleteDir()
    }
  }
}

